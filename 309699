import java.io.*;
import javax.servlet.*;
import javax.servlet.http.*;
import java.sql.*;
public class Stock extends  HttpServlet{
    public  void doPost(HttpServletRequest request ,HttpServletResponse response)throws ServletException,IOException{
        
        try{
        
        if(request.getParameter("create_product")!=null){
            createProduct(request,response);

        }
        }catch(Exception e){

            PrintWriter out = response.getWriter();
            out.println(e);

        }

       response.sendRedirect("add_product");
    }
    
    


   public  void doGet(HttpServletRequest request ,HttpServletResponse response)throws  IOException{

        try{

            if(request.getParameter("delete_product")!=null){
                deleteProduct(request);
                response.sendRedirect("add_product");
                return;
            }

         getProducts(request,response);
         getCategories(request,response);
        request.getRequestDispatcher("add_product.jsp").include(request,response);
        
           

        }catch(Exception e){

            PrintWriter out = response.getWriter();
            out.println(e);

        }

   }


   private void getCategories(HttpServletRequest request,HttpServletResponse response)throws Exception{

     Connection conn = DB.initializeDatabase();
            Statement stmt = conn.createStatement();
            String query = "SELECT * from categories join production_lines on categories.production_line_id=production_lines.production_line_id";
            ResultSet recentCategories = stmt.executeQuery(query);

            getServletContext().setAttribute(
                "recent_categories",recentCategories
            );
      
            //stmt.close();
           // conn.close();
  

   }


   private void getProducts(HttpServletRequest request,HttpServletResponse response)throws Exception{

     Connection conn = DB.initializeDatabase();
            Statement stmt = conn.createStatement();
            String query = "SELECT * from products  join categories on products.category_id=categories.category_id join production_lines on categories.production_line_id=production_lines.production_line_id";
            ResultSet recentProducts = stmt.executeQuery(query);

            getServletContext().setAttribute(
                "recent_products",recentProducts
            );
      
            //stmt.close();
            //conn.close();
  

   }




   private void deleteProduct(HttpServletRequest request)throws Exception{

    Connection conn = DB.initializeDatabase();
    Statement stmt = conn.createStatement();
    int productId = Integer.parseInt(request.getParameter("product_id"));

    String query = "DELETE from products WHERE product_id="+productId;
    stmt.executeUpdate(query);
    stmt.close();
   }
  



     public void createProduct(HttpServletRequest request, 
HttpServletResponse response ) throws Exception{

        // Initialize the database
             Connection con = DB.initializeDatabase();
  
            // Create a SQL query to insert data into demo table
            // demo table consists of two columns, so two '?' is used
            PreparedStatement st = con
                   .prepareStatement("insert into products(product_name,category_id,product_price) values(?,?,?)");
  
            // For the first parameter,
            // get the data using request object
            // sets the data to st pointer
            st.setString(1,request.getParameter("product_name"));
            st.setInt(2, Integer.valueOf(request.getParameter("product_category")));
            // Same for second parameter
            st.setString(3, request.getParameter("product_price"));
  
            // Execute the insert command using executeUpdate()
            // to make changes in database
            st.executeUpdate();
  
            // Close all the connections
            st.close();
            con.close();
            
    }











}