import java.io.*;
import javax.servlet.*;
import javax.servlet.http.*;
import java.sql.*;
public class Statistics extends  HttpServlet{
   
Connection conn;

 public void init(){
  try{
  this.conn = DB.initializeDatabase();
  }catch(Exception e){

  }
 }public  void doGet(HttpServletRequest request ,HttpServletResponse response)throws  IOException{

        try{
        
         getLikes(request,response);
         getCarts(request,response);
         getProducts(request,response);
         getCategories(request,response);
         getCustomers(request,response);
         getRevenue(request,response);
         getMaleSales(request,response);
         getFemaleSales(request,response);
        request.getRequestDispatcher("statistics.jsp").include(request,response);
        
        }catch(Exception e){

            PrintWriter out = response.getWriter();
            out.println(e);

        }

   }


   private void getCategories(HttpServletRequest request,HttpServletResponse response)throws Exception{
            Statement stmt = this.conn.createStatement();
            String query = "SELECT * from categories join production_lines on categories.production_line_id=production_lines.production_line_id";
            ResultSet recentCategories = stmt.executeQuery(query);

            getServletContext().setAttribute(
                "recent_categories",recentCategories
            );
   }


   private void getLikes(HttpServletRequest request,HttpServletResponse response)throws Exception{
       Statement stmt = this.conn.createStatement();
            String query = "SELECT * from product_likes";
            ResultSet likes = stmt.executeQuery(query);

            getServletContext().setAttribute(
                "likes",likes
            );
   }


   int getNumbers(ResultSet rs){

    int counter = 0;

    try{
    if(rs!=null){

      if(rs.next()){
        do{
          counter++;
        }while(rs.next());
      }
    }
    }catch(Exception e){

    }

    return counter;
}



   private void getProducts(HttpServletRequest request,HttpServletResponse response)throws Exception{
            Statement stmt = this.conn.createStatement();
            String query = "SELECT * from products  join categories on products.category_id=categories.category_id join production_lines on categories.production_line_id=production_lines.production_line_id";
            ResultSet recentProducts = stmt.executeQuery(query);

            getServletContext().setAttribute(
                "products",recentProducts
            );
  

   }


    private void getFemaleSales(HttpServletRequest request,HttpServletResponse response)throws Exception{
            Statement stmt = this.conn.createStatement();
            String query = "SELECT * from products  join categories on products.category_id=categories.category_id join production_lines on categories.production_line_id=production_lines.production_line_id join  cart_items on products.product_id=cart_items.product_id join sales on sales.cart_id=cart_items.cart_id join cart on cart.cart_id=sales.cart_id join customers on cart.customer_id=customers.customer_id where customers.gender='F'";
            ResultSet femaleProducts = stmt.executeQuery(query);

            getServletContext().setAttribute(
                "female_sales",femaleProducts
            );
   }


    private void getMaleSales(HttpServletRequest request,HttpServletResponse response)throws Exception{
        Statement stmt = this.conn.createStatement();
            String query = "SELECT * from products  join categories on products.category_id=categories.category_id join production_lines on categories.production_line_id=production_lines.production_line_id join  cart_items on products.product_id=cart_items.product_id join sales on sales.cart_id=cart_items.cart_id join cart on cart.cart_id=sales.cart_id join customers on cart.customer_id=customers.customer_id where customers.gender='M'";
            ResultSet maleProducts = stmt.executeQuery(query);

            getServletContext().setAttribute(
                "male_sales",maleProducts
            );
  
   }

     private void getCustomers(HttpServletRequest request,HttpServletResponse response)throws Exception{

           Statement stmt = this.conn.createStatement();
            String query = "SELECT * from customers";
            ResultSet customersRs = stmt.executeQuery(query);

            getServletContext().setAttribute(
                "customers",customersRs
            );
  
   }


     private void getCarts(HttpServletRequest request,HttpServletResponse response)throws Exception{

            Statement stmt = this.conn.createStatement();
            String query = "SELECT * from sales";
            ResultSet salesRs = stmt.executeQuery(query);

            getServletContext().setAttribute(
                "sales",salesRs
            );
  
    }


     private void getRevenue(HttpServletRequest request,HttpServletResponse response)throws Exception{

        Statement stmt = this.conn.createStatement();
            String query = "SELECT sum(product_price) as revenue from products join cart_items on cart_items.product_id=products.product_id join cart on cart_items.cart_id = cart.cart_id join sales on cart.cart_id=sales.cart_id";
            ResultSet revenueRs = stmt.executeQuery(query);

            String revenue = "";
            if(revenueRs.next()){
                revenue = revenueRs.getString("revenue");
            }

            getServletContext().setAttribute(
                "revenue",revenue
            );
  
   }

    public void destroy(){
    try{

    this.conn.close();
    }catch(Exception e){

    }
   }

}